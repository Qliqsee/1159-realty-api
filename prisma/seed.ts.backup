import { PrismaClient } from '@prisma/client';
import * as bcrypt from 'bcrypt';

const prisma = new PrismaClient();

async function main() {
  console.log('Starting seed...');

  const hashedPassword = await bcrypt.hash('password123', 10);

  // ========== DEFINE ALL ROLES ==========
  const roleDefinitions = [
    { name: 'admin', description: 'Administrator with full system access' },
    { name: 'manager', description: 'Manager with broad system access' },
    { name: 'agent', description: 'Sales agent' },
    { name: 'client', description: 'Client user' },
    { name: 'partner', description: 'Business partner' },
    { name: 'operations-manager', description: 'Operations Manager' },
    { name: 'operations', description: 'Operations staff' },
    { name: 'hr', description: 'Human Resources' },
    { name: 'hr-manager', description: 'Human Resources Manager' },
    { name: 'accounting', description: 'Accounting staff' },
    { name: 'accounting-manager', description: 'Accounting Manager' },
    { name: 'sales-manager', description: 'Sales Manager' },
    { name: 'sales', description: 'Sales staff' },
    { name: 'media-manager', description: 'Media Manager' },
    { name: 'media', description: 'Media staff' },
    { name: 'cst', description: 'Customer Service Team' },
    { name: 'cst-manager', description: 'Customer Service Team Manager' },
    { name: 'facility-manager', description: 'Facility Manager' },
    { name: 'facility', description: 'Facility staff' },
  ];

  const adminRoleNames = roleDefinitions
    .filter((r) => !['client', 'partner'].includes(r.name))
    .map((r) => r.name);

  // ========== CREATE ROLES ==========
  const roles: Record<string, any> = {};
  for (const roleDef of roleDefinitions) {
    roles[roleDef.name] = await prisma.role.upsert({
      where: { name_appContext: { name: roleDef.name, appContext: 'SYSTEM' } },
      update: {},
      create: {
        name: roleDef.name,
        appContext: 'SYSTEM',
        description: roleDef.description,
      },
    });
    console.log(`✓ Role created: ${roleDef.name}`);
  }

  // ========== DEFINE ALL RESOURCES ==========
  const resourceList = [
    'dashboard',
    'leads',
    'properties',
    'clients',
    'client-interests',
    'partner-applications',
    'partners',
    'agents',
    'enrollments',
    'invoices',
    'payments',
    'kyc',
    'disbursements',
    'campaigns',
    'documentation',
    'support',
    'analytics',
    'team',
    'reports',
    'recommendations',
    'sales',
    'schedules',
  ];

  // ========== CREATE RESOURCES ==========
  const resources: Record<string, any> = {};
  for (const resName of resourceList) {
    resources[resName] = await prisma.resource.upsert({
      where: { name: resName },
      update: {},
      create: {
        name: resName,
        description: `${resName.charAt(0).toUpperCase() + resName.slice(1)} resource`,
      },
    });
    console.log(`✓ Resource created: ${resName}`);
  }

  // ========== DEFINE ALL ACTIONS ==========
  const actionList = [
    'view',
    'create',
    'update',
    'delete',
    'manage',
    'assign-manager',
    'assign-hr-manager',
    'assign-others',
    'ban-manager',
    'ban-hr-manager',
    'ban-others',
  ];

  // ========== CREATE ACTIONS ==========
  const actions: Record<string, any> = {};
  for (const actionName of actionList) {
    actions[actionName] = await prisma.action.upsert({
      where: { name: actionName },
      update: {},
      create: {
        name: actionName,
        description: `${actionName.charAt(0).toUpperCase() + actionName.slice(1)} action`,
      },
    });
    console.log(`✓ Action created: ${actionName}`);
  }

  // ========== DEFINE ROLE-RESOURCE-ACTIONS RULES ==========
  const roleResourceRules: Record<
    string,
    { manage: string[]; others: string[] }
  > = {
    dashboard: { manage: adminRoleNames, others: adminRoleNames },
    leads: {
      manage: ['admin', 'manager', 'sales-manager'],
      others: adminRoleNames,
    },
    properties: {
      manage: [
        'admin',
        'manager',
        'cst',
        'cst-manager',
        'accounting',
        'accounting-manager',
      ],
      others: adminRoleNames,
    },
    clients: {
      manage: ['admin', 'manager', 'cst', 'cst-manager'],
      others: adminRoleNames,
    },
    'client-interests': {
      manage: ['admin', 'manager', 'cst', 'cst-manager'],
      others: adminRoleNames,
    },
    'partner-applications': {
      manage: ['admin', 'manager', 'hr', 'hr-manager'],
      others: adminRoleNames,
    },
    partners: {
      manage: ['admin', 'manager', 'hr', 'hr-manager'],
      others: adminRoleNames,
    },
    agents: {
      manage: ['admin', 'manager', 'hr-manager', 'sales-manager'],
      others: adminRoleNames,
    },
    enrollments: {
      manage: [
        'admin',
        'manager',
        'accounting',
        'accounting-manager',
        'cst',
        'cst-manager',
      ],
      others: adminRoleNames,
    },
    invoices: {
      manage: [
        'admin',
        'manager',
        'accounting',
        'accounting-manager',
        'cst',
        'cst-manager',
      ],
      others: adminRoleNames,
    },
    payments: {
      manage: [
        'admin',
        'manager',
        'accounting',
        'accounting-manager',
        'cst',
        'cst-manager',
      ],
      others: adminRoleNames,
    },
    kyc: {
      manage: ['admin', 'manager', 'cst', 'cst-manager'],
      others: adminRoleNames,
    },
    disbursements: {
      manage: ['admin', 'manager', 'accounting', 'accounting-manager'],
      others: adminRoleNames,
    },
    campaigns: {
      manage: ['admin', 'manager', 'media-manager', 'media'],
      others: adminRoleNames,
    },
    documentation: {
      manage: ['admin', 'manager', 'cst-manager', 'cst'],
      others: adminRoleNames,
    },
    support: {
      manage: ['admin', 'manager', 'cst-manager', 'cst'],
      others: adminRoleNames,
    },
    analytics: {
      manage: ['admin', 'manager', 'accounting-manager'],
      others: adminRoleNames,
    },
    team: {
      manage: ['admin', 'manager', 'hr-manager'],
      others: adminRoleNames,
    },
    reports: {
      manage: ['admin', 'manager', 'accounting-manager'],
      others: adminRoleNames,
    },
    recommendations: {
      manage: ['admin', 'manager'],
      others: adminRoleNames,
    },
    sales: {
      manage: ['admin', 'manager', 'sales-manager'],
      others: adminRoleNames,
    },
    schedules: {
      manage: [
        'admin',
        'manager',
        'operations',
        'operations-manager',
        'cst',
        'cst-manager',
      ],
      others: adminRoleNames,
    },
  };

  // ========== ASSIGN RESOURCES TO ROLES WITH ACTIONS ==========
  const standardActions = ['view', 'create', 'update', 'delete'];
  const manageAction = 'manage';

  for (const [resourceName, rules] of Object.entries(roleResourceRules)) {
    const resource = resources[resourceName];

    // Assign manage action to specific roles
    for (const roleName of rules.manage) {
      const role = roles[roleName];
      const actionsForRole = [...standardActions, manageAction];

      await prisma.roleResource.upsert({
        where: {
          roleId_resourceId: { roleId: role.id, resourceId: resource.id },
        },
        update: { actions: actionsForRole },
        create: {
          roleId: role.id,
          resourceId: resource.id,
          actions: actionsForRole,
        },
      });
    }

    // Assign standard actions to other admin roles
    for (const roleName of rules.others) {
      const role = roles[roleName];
      if (rules.manage.includes(roleName)) continue; // Skip if already has manage

      await prisma.roleResource.upsert({
        where: {
          roleId_resourceId: { roleId: role.id, resourceId: resource.id },
        },
        update: { actions: standardActions },
        create: {
          roleId: role.id,
          resourceId: resource.id,
          actions: standardActions,
        },
      });
    }

    console.log(`✓ Permissions assigned for resource: ${resourceName}`);
  }

  // ========== CREATE DEFAULT ADMIN USER ==========
  const existingAdmin = await prisma.user.findUnique({
    where: { email: 'admin@example.com' },
  });

  if (!existingAdmin) {
    const adminUser = await prisma.user.create({
      data: {
        email: 'admin@example.com',
        password: hashedPassword,
        isEmailVerified: true,
      },
    });

    await prisma.admin.create({
      data: {
        userId: adminUser.id,
        firstName: 'Super',
        lastName: 'Admin',
      },
    });

    await prisma.userRole.create({
      data: {
        userId: adminUser.id,
        roleId: roles.admin.id,
      },
    });

    console.log('✓ Default admin user created: admin@example.com / password123');
  }

  console.log('✅ Seed completed successfully!');
}

main()
  .catch((e) => {
    console.error('❌ Seed failed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
