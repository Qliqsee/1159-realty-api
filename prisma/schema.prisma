// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Gender {
  MALE
  FEMALE
  PREFER_NOT_TO_SAY
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum EmploymentStatus {
  EMPLOYED
  SELF_EMPLOYED
  UNEMPLOYED
}

enum KycStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum KycStep {
  PERSONAL
  ADDRESS
  OCCUPATION
  IDENTITY
  NEXT_OF_KIN
  BANK
}

enum PropertyType {
  LAND
  APARTMENT
}

enum PropertyStatus {
  AVAILABLE
  PRE_LAUNCH
  SOLD_OUT
  RESERVED
  ARCHIVED
}

enum UnitStatus {
  AVAILABLE
  SOLD
  RESERVED
  ARCHIVED
}

enum MediaType {
  IMAGE
  VIDEO
  YOUTUBE
  INSTAGRAM
}

enum LeadStatus {
  AVAILABLE
  RESERVED
  CLOSED
}

model User {
  id                     String   @id @default(uuid())
  email                  String   @unique
  password               String?
  googleId               String?  @unique
  name                   String?
  isEmailVerified        Boolean  @default(false)
  hasCompletedOnboarding Boolean  @default(false)
  gender                 Gender?
  referralSource         String?
  country                String?
  state                  String?
  leadId                 String?  @unique
  closedBy               String?
  isSuspended            Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  userRoles               UserRole[]
  emailOtps               EmailOtp[]
  passwordResetTokens     PasswordResetToken[]
  kyc                     Kyc?
  kycCreatedRecords       Kyc[]                @relation("KycCreatedBy")
  kycUpdatedRecords       Kyc[]                @relation("KycUpdatedBy")
  kycReviewedRecords      Kyc[]                @relation("KycReviewedBy")
  rejectionReasonsCreated KycRejectionReason[] @relation("RejectionCreatedBy")
  kycHistoryReviewed      KycHistory[]         @relation("KycHistoryReviewedBy")
  propertyInterests       PropertyInterest[]
  lead                    Lead?                @relation("LeadToClient", fields: [leadId], references: [id])
  closedByAgent           User?                @relation("ClosedByAgent", fields: [closedBy], references: [id])
  closedClients           User[]               @relation("ClosedByAgent")
  leadsCreated            Lead[]               @relation("LeadCreatedBy")
  leadsClosed             Lead[]               @relation("LeadClosedBy")
  leadsReserved           Lead[]               @relation("LeadReservedBy")
  leadsStatusChanged      Lead[]               @relation("LeadStatusChangedBy")
  leadFeedbacks           LeadFeedback[]
  leadAgentHistory        LeadAgentHistory[]

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String
  appContext  String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([name, appContext])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model EmailOtp {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@map("email_otps")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, expiresAt])
  @@map("password_reset_tokens")
}

model Kyc {
  id          String    @id @default(uuid())
  userId      String    @unique
  status      KycStatus @default(DRAFT)
  currentStep KycStep   @default(PERSONAL)

  personal   Json?
  address    Json?
  occupation Json?
  identity   Json?
  nextOfKin  Json?
  bank       Json?

  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer         User?                @relation("KycReviewedBy", fields: [reviewedBy], references: [id])
  creator          User?                @relation("KycCreatedBy", fields: [createdBy], references: [id])
  updater          User?                @relation("KycUpdatedBy", fields: [updatedBy], references: [id])
  rejectionReasons KycRejectionReason[]
  history          KycHistory[]

  @@map("kyc")
}

model KycRejectionReason {
  id        String   @id @default(uuid())
  kycId     String
  reason    String
  createdAt DateTime @default(now())
  createdBy String

  kyc     Kyc  @relation(fields: [kycId], references: [id], onDelete: Cascade)
  creator User @relation("RejectionCreatedBy", fields: [createdBy], references: [id])

  @@map("kyc_rejection_reasons")
}

model KycHistory {
  id     String    @id @default(uuid())
  kycId  String
  status KycStatus

  personal   Json?
  address    Json?
  occupation Json?
  identity   Json?
  nextOfKin  Json?
  bank       Json?

  submittedAt      DateTime
  reviewedAt       DateTime?
  reviewedBy       String?
  reviewAction     String?
  rejectionReasons String[]

  createdAt DateTime @default(now())

  kyc      Kyc   @relation(fields: [kycId], references: [id], onDelete: Cascade)
  reviewer User? @relation("KycHistoryReviewedBy", fields: [reviewedBy], references: [id])

  @@map("kyc_history")
}

model State {
  id        Int      @id
  name      String   @unique
  createdAt DateTime @default(now())

  properties Property[]

  @@map("states")
}

model Property {
  id          String         @id @default(uuid())
  name        String
  type        PropertyType
  subtype     String
  status      PropertyStatus @default(AVAILABLE)
  description String         @db.Text

  agriculturalFeeAmount   Decimal? @db.Decimal(15, 2)
  agriculturalFeeIsActive Boolean  @default(false)
  requiredDocuments       String[]

  country        String
  stateId        Int?
  address        String @db.Text
  nearbyLandmark String

  overdueInterestRate Decimal @db.Decimal(5, 2)
  paymentCycle        Int

  salesDiscountPercentage Decimal? @db.Decimal(5, 2)
  salesDiscountIsActive   Boolean  @default(false)

  mapConfigSrc    String?
  mapConfigWidth  String?
  mapConfigHeight String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String
  lastUpdatedBy String

  state             State?                @relation(fields: [stateId], references: [id])
  unitPricing       PropertyUnitPricing[]
  paymentPlans      PropertyPaymentPlan[]
  features          PropertyFeature[]
  media             PropertyMedia[]
  units             Unit[]
  propertyInterests PropertyInterest[]

  @@map("properties")
}

model PropertyUnitPricing {
  id             String   @id @default(uuid())
  propertyId     String
  unit           String
  regularPrice   Decimal  @db.Decimal(15, 2)
  prelaunchPrice Decimal  @db.Decimal(15, 2)
  createdAt      DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("property_unit_pricing")
}

model PropertyPaymentPlan {
  id             String   @id @default(uuid())
  propertyId     String
  durationMonths Int
  interestRate   Decimal  @db.Decimal(5, 2)
  createdAt      DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("property_payment_plans")
}

model PropertyFeature {
  id         String   @id @default(uuid())
  propertyId String
  name       String
  icon       String
  createdAt  DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("property_features")
}

model PropertyMedia {
  id           String    @id @default(uuid())
  propertyId   String
  type         MediaType
  url          String
  isPrimary    Boolean   @default(false)
  displayOrder Int       @default(0)
  caption      String?
  thumbnail    String?
  createdAt    DateTime  @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("property_media")
}

model Unit {
  id         String     @id @default(uuid())
  propertyId String
  unitId     String
  unit       String
  coordinate String
  feature    String?
  status     UnitStatus @default(AVAILABLE)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, unitId])
  @@map("units")
}

model PropertyInterest {
  id         String   @id @default(uuid())
  propertyId String
  userId     String
  message    String?
  createdAt  DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
  @@map("property_interests")
}

model Lead {
  id                   String     @id @default(uuid())
  email                String
  firstName            String
  lastName             String
  phone                String?
  status               LeadStatus @default(AVAILABLE)
  reservedBy           String?
  reservationExpiresAt DateTime?
  addedBy              String
  closedBy             String?
  clientId             String?    @unique
  statusChangedAt      DateTime?
  statusChangedBy      String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  creator       User               @relation("LeadCreatedBy", fields: [addedBy], references: [id])
  closer        User?              @relation("LeadClosedBy", fields: [closedBy], references: [id])
  reserver      User?              @relation("LeadReservedBy", fields: [reservedBy], references: [id])
  statusChanger User?              @relation("LeadStatusChangedBy", fields: [statusChangedBy], references: [id])
  client        User?              @relation("LeadToClient")
  feedbacks     LeadFeedback[]
  agentHistory  LeadAgentHistory[]

  @@index([email])
  @@index([status])
  @@index([reservedBy])
  @@index([addedBy])
  @@map("leads")
}

model LeadFeedback {
  id        String   @id @default(uuid())
  leadId    String
  agentId   String
  comment   String   @db.Text
  createdAt DateTime @default(now())

  lead  Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent User @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([agentId])
  @@map("lead_feedbacks")
}

model LeadAgentHistory {
  id           String    @id @default(uuid())
  leadId       String
  agentId      String
  assignedAt   DateTime  @default(now())
  unassignedAt DateTime?
  reason       String?

  lead  Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent User @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([agentId])
  @@map("lead_agent_history")
}
