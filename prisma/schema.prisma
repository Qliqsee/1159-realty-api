// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Gender {
  MALE
  FEMALE
  PREFER_NOT_TO_SAY
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum EmploymentStatus {
  EMPLOYED
  SELF_EMPLOYED
  UNEMPLOYED
}

enum KycStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum KycStep {
  PERSONAL
  ADDRESS
  OCCUPATION
  IDENTITY
  NEXT_OF_KIN
  BANK
}

model User {
  id                     String   @id @default(uuid())
  email                  String   @unique
  password               String?
  googleId               String?  @unique
  name                   String?
  isEmailVerified        Boolean  @default(false)
  hasCompletedOnboarding Boolean  @default(false)
  gender                 Gender?
  referralSource         String?
  country                String?
  state                  String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  userRoles               UserRole[]
  emailOtps               EmailOtp[]
  passwordResetTokens     PasswordResetToken[]
  kyc                     Kyc?
  kycCreatedRecords       Kyc[]                @relation("KycCreatedBy")
  kycUpdatedRecords       Kyc[]                @relation("KycUpdatedBy")
  kycReviewedRecords      Kyc[]                @relation("KycReviewedBy")
  rejectionReasonsCreated KycRejectionReason[] @relation("RejectionCreatedBy")
  kycHistoryReviewed      KycHistory[]         @relation("KycHistoryReviewedBy")

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String
  appContext  String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([name, appContext])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model EmailOtp {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@map("email_otps")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, expiresAt])
  @@map("password_reset_tokens")
}

model Kyc {
  id          String    @id @default(uuid())
  userId      String    @unique
  status      KycStatus @default(DRAFT)
  currentStep KycStep   @default(PERSONAL)

  personal   Json?
  address    Json?
  occupation Json?
  identity   Json?
  nextOfKin  Json?
  bank       Json?

  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer         User?                @relation("KycReviewedBy", fields: [reviewedBy], references: [id])
  creator          User?                @relation("KycCreatedBy", fields: [createdBy], references: [id])
  updater          User?                @relation("KycUpdatedBy", fields: [updatedBy], references: [id])
  rejectionReasons KycRejectionReason[]
  history          KycHistory[]

  @@map("kyc")
}

model KycRejectionReason {
  id        String   @id @default(uuid())
  kycId     String
  reason    String
  createdAt DateTime @default(now())
  createdBy String

  kyc     Kyc  @relation(fields: [kycId], references: [id], onDelete: Cascade)
  creator User @relation("RejectionCreatedBy", fields: [createdBy], references: [id])

  @@map("kyc_rejection_reasons")
}

model KycHistory {
  id     String    @id @default(uuid())
  kycId  String
  status KycStatus

  personal   Json?
  address    Json?
  occupation Json?
  identity   Json?
  nextOfKin  Json?
  bank       Json?

  submittedAt      DateTime
  reviewedAt       DateTime?
  reviewedBy       String?
  reviewAction     String?
  rejectionReasons String[]

  createdAt DateTime @default(now())

  kyc      Kyc   @relation(fields: [kycId], references: [id], onDelete: Cascade)
  reviewer User? @relation("KycHistoryReviewedBy", fields: [reviewedBy], references: [id])

  @@map("kyc_history")
}
