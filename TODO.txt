CLIENT MODULE OPTIMIZATION - EFFICIENCY AND CONSISTENCY IMPROVEMENTS

CONTEXT AND GOALS:
The client module currently has performance issues due to heavy database joins, inconsistent response structures across endpoints, and data duplication between Client table and KYC JSON. The server is not very powerful so we need to optimize queries and reduce unnecessary joins. The goal is to standardize client responses, make them efficient with selective loading via query parameters, and establish a clear data storage strategy.

KEY PRINCIPLES:
1. Single source of truth for personal data is KYC JSON
2. Denormalize frequently queried fields to Client table for analytics and fast filtering (firstName, lastName, phone, gender, country, state)
3. All client endpoints return the same base structure, only capabilities differ (empty unless explicitly requested via query param or user requesting their own profile)
4. Use query parameters to selectively include related data (kyc, partnership, agent, partner, capabilities) to avoid unnecessary joins
5. Remove bank data from Client table - it should only exist in KYC JSON
6. Remove enrollment data from client responses - should be fetched separately
7. Remove lead data from client responses entirely

DATA STORAGE STRATEGY - HYBRID APPROACH:
Client Table Columns: Store firstName, lastName, phone, gender, country, state for fast analytics and filtering. Remove accountNumber, bankCode, accountName, bankName (bank data only in KYC JSON).
KYC JSON: Source of truth containing all data including personal info, address, occupation, identity, nextOfKin, and bank details.
Sync Workflow: When KYC is approved, automatically copy firstName, lastName, phone, gender, country, state from KYC JSON to Client table columns.
Rationale: PostgreSQL can query JSON fields but it is slower than regular columns even with indexes. For analytics, recommendation engines, and segmentation features we need fast access to common fields like gender, country, state. Storing these in regular columns gives performance while KYC JSON maintains the complete authoritative record.

PHASE 1: DATABASE SCHEMA CHANGES
Update prisma/schema.prisma Client model to remove bank fields: accountNumber, bankCode, accountName, bankName. These should only exist in KYC JSON bank field.
Verify Client model keeps firstName, lastName, phone, gender, country, state columns for analytics. Add otherName if missing for completeness.
Verify Client model removes leadId field and the lead relation since lead data should not be in client responses.
Run prisma migrate dev to create migration for removing bank fields and leadId.
Update database with the migration.

PHASE 2: DTO RESTRUCTURING
Delete src/clients/dto/client-response.dto.ts file entirely. We will create a new unified structure.
Create new src/clients/dto/client-response.dto.ts with single unified ClientResponseDto class.
ClientResponseDto base fields always returned: id, userId, email, isEmailVerified, firstName, lastName, otherName, phone, gender, referralSource, country, state, hasCompletedOnboarding, partnerLink, referredByPartnerId, closedBy (just ID string), isSuspended, isBanned, roles (string array), createdAt, updatedAt.
ClientResponseDto optional fields with ApiPropertyOptional decorator: capabilities (string array), kyc (KycSummaryDto), partnership (PartnershipSummaryDto), closedByAgent (AdminSummaryDto), referredByPartner (ClientSummaryDto).
Remove these fields entirely from DTO: leadId, lead object, enrollments array.
Create ClientListResponseDto with data array of ClientResponseDto and meta PaginationMetaDto for paginated list endpoints.
Keep ReferralsResponseDto as is since it has different structure (totalReferrals count and referrals array).
Update BankAccountResponseDto to remain for bank account specific endpoints but note these will be moved to KYC module later.

PHASE 3: CREATE QUERY PARAM DTO
Create src/clients/dto/client-query.dto.ts for query parameters.
Define ClientIncludeQueryDto class with optional boolean fields: includeCapabilities, includeKyc, includePartnership, includeAgent, includePartner.
Use IsBoolean and IsOptional decorators with Transform decorator to handle string to boolean conversion (query params are strings).
Add ApiPropertyOptional decorators for Swagger documentation with examples showing ?includeCapabilities=true.

PHASE 4: UPDATE CLIENT SERVICE
Refactor findByUserId method in src/clients/clients.service.ts to accept optional query params object.
For GET /clients/me always fetch capabilities regardless of query param (special case for authenticated user requesting own profile).
Conditionally include related data in Prisma query based on query params: only include user.userRoles.role if always needed for roles array, only include kyc if includeKyc is true, only include partnership if includePartnership is true, only include closedByAgent.user if includeAgent is true, only include referredByPartner.user if includePartner is true.
Remove enrollmentsAsClient include entirely from all queries.
Remove lead include entirely from all queries.
Refactor findOne method to accept optional query params object and conditionally include relations based on params.
Default behavior when no query params: only return base client fields with no optional relations (minimal joins for performance).
Update mapToClientResponse private method to handle optional fields, set them to undefined if not included in query.
Remove mapToClientProfileResponse method since we now have unified response structure.
Remove mapToClientDetail method since we now have unified response structure.
Create single mapping method mapToClientResponse that checks which relations are loaded and maps them accordingly.
When mapping capabilities, call capabilitiesService.getUserCapabilities only if capabilities were requested.
When mapping kyc, use KycSummaryDto structure with id, status, currentStep, submittedAt, reviewedAt.
When mapping partnership, use PartnershipSummaryDto structure.
When mapping closedByAgent, use AdminSummaryDto structure with mapToAdminSummary method.
When mapping referredByPartner, use ClientSummaryDto structure with mapToClientSummary method (recursive but only summary fields).
Keep mapToClientSummary method as is for summary representations used in other DTOs.
Keep mapToAdminSummary method as is for agent summaries.

PHASE 5: UPDATE CLIENT CONTROLLER
Import ClientIncludeQueryDto in src/clients/clients.controller.ts.
Update GET /clients/me endpoint to accept @Query() query: ClientIncludeQueryDto parameter.
Pass query params to clientsService.findByUserId method but note capabilities are always included for /me endpoint.
Update ApiResponse decorator to use ClientResponseDto instead of ClientProfileResponseDto.
Update GET /clients/:id endpoint to accept @Query() query: ClientIncludeQueryDto parameter.
Pass query params to clientsService.findOne method.
Update ApiResponse decorator to use ClientResponseDto instead of ClientDetailResponseDto.
Add ApiQuery decorators for each query parameter to document them in Swagger with examples.
Remove or keep bank account endpoints as needed (updateBankAccount, getBankAccount, deleteBankAccount) but note these should eventually move to KYC module since bank data is part of KYC.

PHASE 6: UPDATE KYC SERVICE FOR DATA SYNC
Open src/kyc/kyc.service.ts and locate the approval workflow where KYC status changes to APPROVED.
Add logic to sync firstName, lastName, phone, gender, country, state from KYC JSON personal and address fields to Client table columns when KYC is approved.
Extract personal.firstName or personal.first_name (check actual JSON structure in KYC) and update client.firstName.
Extract personal.lastName or personal.last_name and update client.lastName.
Extract personal.phone and update client.phone.
Extract personal.gender and update client.gender.
Extract address.country and update client.country.
Extract address.state and update client.state.
Use prisma.client.update to save these fields to Client table after KYC approval.
Add error handling in case JSON fields are missing or null.
Add logging to track when sync happens for debugging.
Consider if otherName should also be synced from KYC personal data.

PHASE 7: UPDATE BANK ACCOUNT ENDPOINTS CONTEXT
The bank account endpoints in ClientsController (updateBankAccount, getBankAccount, deleteBankAccount) currently operate on Client table bank fields which we are removing.
These endpoints should eventually be moved to KYC module or updated to work with KYC JSON bank field instead.
For now, mark these endpoints as deprecated or remove them entirely since bank data should only be managed through KYC submission flow.
Update UpdateClientDto to remove bank fields: accountNumber, bankCode, accountName, bankName.
Update src/clients/dto/update-client.dto.ts to only include fields that should be updatable outside of KYC (likely just referralSource or other non-KYC fields).
Consider if clients should be able to update firstName, lastName, phone etc directly or only through KYC process.

PHASE 8: UPDATE AUTH RESPONSES
Check src/auth/auth.service.ts and src/auth/auth.controller.ts for any client responses in login, register, or token refresh endpoints.
Ensure auth endpoints return unified ClientResponseDto structure with capabilities included by default for authenticated user.
Update AuthResponseDto in src/auth/dto/auth-response.dto.ts if it includes client object to use new ClientResponseDto.
Ensure login and register flows return capabilities for the authenticated user.

PHASE 9: TESTING AND VALIDATION
Test GET /clients/me without query params - should return base fields plus capabilities.
Test GET /clients/me?includeKyc=true - should return base fields, capabilities, and kyc summary.
Test GET /clients/me?includePartnership=true&includeAgent=true - should return base fields, capabilities, partnership, and agent.
Test GET /clients/:id without query params - should return only base fields, no capabilities.
Test GET /clients/:id?includeCapabilities=true - should return empty capabilities array since not requesting own profile.
Test GET /clients/:id?includeKyc=true&includePartner=true - should return base fields with kyc and partner.
Test KYC approval workflow - verify that firstName, lastName, phone, gender, country, state are synced from KYC JSON to Client table columns.
Verify client responses no longer include leadId, lead object, or enrollments array.
Verify bank account endpoints are removed or deprecated.
Check Swagger docs to ensure query parameters are documented properly.
Verify performance improvement by checking SQL queries logged by Prisma - should see fewer joins when query params not specified.
Test analytics queries on Client table using firstName, lastName, phone, gender, country, state columns to ensure they work efficiently.

IMPLEMENTATION NOTES:
Do not create any progress tracking in terminal or conversation. Only update this TODO.txt file.
Remove completed tasks from this file as you finish them.
The database in use is DATABASE_URL="postgresql://postgres:postgres@localhost:5432/realty_db?schema=public" in .env.local.
Do not create any .md files unless explicitly requested.
After all phases complete, run the application with npm run start:dev:local and test the endpoints thoroughly.
DO NOT WRITE Integration or unit test for any reason.
