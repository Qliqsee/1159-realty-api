INVOICE FEATURES TODO

BUSINESS RULES (CRITICAL - MUST BE ENFORCED):
1. Invoices CANNOT be manually cancelled - they can only be resolved (paid) or unresolved (unpaid)
2. When an enrollment is cancelled, ALL unpaid invoices linked to that enrollment are AUTOMATICALLY cancelled
3. When invoices are cancelled due to enrollment cancellation, their associated pending commissions are also cancelled/deleted
4. No email notifications for invoice cancellation - only enrollment cancellation emails are sent
5. Invoice cancellation ONLY happens as a result of enrollment cancellation, never independently
6. Relationships: Invoice -> Enrollment -> Property (invoices are always linked to an enrollment)

EXISTING FEATURES (Already Implemented):
- Invoice model with all necessary fields
- GET /invoices - List all invoices with pagination, search, and filters (admin only)
- GET /invoices/my-invoices - List agent's own invoices (agent only)
- GET /invoices/client - List client's own invoices (client only)
- GET /invoices/:id - Get invoice detail with role-based access (admin/agent/client)
- POST /invoices/:id/resolve - Manually resolve invoice payment (admin only)
- POST /invoices/:id/undo - Undo invoice payment (admin only)
- POST /payments/initialize - Initialize Paystack payment for invoice
- GET /payments/verify/:reference - Verify payment status
- GET /payments/payment-links/:token - Get payment link details (public)
- POST /payments/webhook - Paystack webhook for payment updates
- Cron job for daily overdue invoice check and auto-suspend
- Cron job for hourly upcoming invoice reminders
- Email templates for invoice overdue and reminders
- Sequential payment validation
- Overdue fee calculation
- Commission creation on payment
- Grace period tracking (32 days total)

COMPLETED FEATURES:
✓ 0. Fixed enrollment cancellation to handle invoice and commission cancellation
✓ 1. Added partnerId filter to QueryInvoicesDto
✓ 2. Created GET /invoices/partner endpoint for partners
✓ 3. Created GET /invoices/stats endpoint for admin statistics
✓ 4. Created GET /invoices/:id/download endpoint - Download invoice as PDF
✓ 5. Enhanced search to include partnerName, agentName, and propertyName
✓ 6. Updated Swagger documentation for all invoice endpoints
✓ 7. Created invoice PDF generation service with professional template using pdfkit
✓ 8. Ensured proper role-based access control for all invoice endpoints

MISSING FEATURES TO IMPLEMENT:
None - All invoice features completed!

VERIFIED IMPLEMENTATION NOTES:
- Schema has proper cascade deletes: Invoice -> Enrollment (onDelete: Cascade), Commission -> Invoice (onDelete: Cascade)
- However, business rules require CANCELLING invoices (status update), NOT deleting them
- The cancel logic must preserve paid invoices and their commissions
- Only unpaid invoices (PENDING, OVERDUE) should be cancelled
- Only PENDING commissions should be deleted when invoice is cancelled
- PAID commissions must remain intact even if enrollment is cancelled
