ENROLLMENT MANAGEMENT - IN PROGRESS

=== COMPLETED ===
✅ Database schema: Enrollment, Invoice, Commission, PaymentLink models with all relations
✅ Prisma migration applied successfully (20260108085129_add_enrollment_invoice_commission_payment_link_models)
✅ Enrollments module: module, controller, service fully implemented
✅ Enrollments service: All methods implemented (create, findAll, findOne, cancel, resume, linkClient, generatePaymentLink, getStats)
✅ Enrollments controller: 10 endpoints with full Swagger docs and RBAC guards
   - POST /enrollments (admin/agent)
   - GET /enrollments (admin)
   - GET /enrollments/my-enrollments (agent)
   - GET /enrollments/client (client)
   - GET /enrollments/stats (admin)
   - GET /enrollments/:id (admin/agent/client)
   - PATCH /enrollments/:id/cancel (admin)
   - PATCH /enrollments/:id/resume (admin)
   - PATCH /enrollments/:id/link-client (admin)
   - POST /enrollments/:id/generate-payment-link (admin/agent)
✅ All DTOs created for enrollments, invoices, commissions
✅ Build status: Project compiles successfully
✅ Test files removed (per user instruction)

=== NEXT TASK: INVOICES SERVICE ===

LOCATION: src/invoices/invoices.service.ts (currently empty)

WHAT TO IMPLEMENT:
1. Inject PrismaService in constructor
2. Create findAll() method
   - Parameters: QueryInvoicesDto, optional userId, userRole
   - Add pagination, search, filters (status, enrollmentId, agentId, dueDateFrom, dueDateTo, overdue)
   - Include: enrollment details, agent, partner, client info
   - Apply role-based filtering if needed
   - Calculate overdue days for each invoice
   - Return formatted response with meta

3. Create findOne() method
   - Parameters: id, optional userId, userRole
   - Get invoice with all related data
   - Check access rights based on role
   - Return InvoiceDetailResponseDto

4. Create resolve() method (manual payment)
   - Parameters: id, ResolveInvoiceDto, userId
   - Validate invoice exists and not already paid
   - Validate sequential payment (previous invoices must be paid first)
   - Update invoice: status=PAID, amountPaid=amount, paidAt=now, paymentReference
   - Update enrollment: amountPaid += invoice.amount
   - Create commission records (agent 7%, partner 3% if applicable)
   - Check if all invoices paid -> update enrollment status to COMPLETED
   - Apply overdue fee if applicable
   - Return updated invoice

5. Create undoPayment() method
   - Parameters: id, userId
   - Validate invoice exists and is paid
   - Only allow undo if it's the most recent payment (sequential rule)
   - Update invoice: status=PENDING/OVERDUE, amountPaid=0, paidAt=null, paymentReference=null
   - Update enrollment: amountPaid -= invoice.amount, status=ONGOING
   - Delete/mark commission records as cancelled
   - Return updated invoice

PATTERN REFERENCE:
Look at src/enrollments/enrollments.service.ts for the implementation pattern:
- Use PrismaService for database operations
- Use Prisma.InvoiceWhereInput for type-safe queries
- Throw NotFoundException, BadRequestException, ForbiddenException as needed
- Use Number() to convert Decimal to number for responses
- Use transactions for multi-step operations

DEPENDENCIES:
- PrismaService: Already available
- DTOs: Already created in src/invoices/dto/
- Enums: Use from @prisma/client (InvoiceStatus, CommissionStatus, CommissionType)

NOTES:
- Overdue fee should be a fixed amount per invoice (stored in property.overdueInterestRate)
- Grace period tracking happens in enrollment (32 days total)
- Commission calculation: agent gets 7%, partner gets 3% if client has approved partner
- Sequential payment: Cannot pay invoice N if invoice N-1 is not paid

=== AFTER INVOICES SERVICE ===
Next steps in order:
1. Update invoices module to add PrismaService provider
2. Implement invoices controller with endpoints
3. Implement commissions service
4. Update commissions module to add PrismaService provider
5. Implement commissions controller
6. Implement Paystack payment integration
7. Implement overdue management cron job
8. Create and assign permissions
9. Update property stats endpoint
